<main class="container-xxl">
  <header class="TicketDetail-header">
    <button class="btn-atras" (click)="volver()">
      <mat-icon>keyboard_backspace</mat-icon>Atr√°s
    </button>
    <p class="title-page">{{ isAdmin ? 'Tickets ‚Äì Detalle' : 'Mis Tickets - Detalle' }}</p>
  </header>

  @if (!dato()) {
  <p>No hay datos disponibles</p>
  } @else {
  <div class="ticket-detalle">

    <!-- üßæ Informaci√≥n general -->
    <div class="title">
      <mat-icon class="bg-gradient-primary">local_activity</mat-icon>
      <h2>{{ dato()?.titulo }}</h2>

      <div class="content-group">
        <span>Descripci√≥n</span>
        <p>{{ (dato()?.descripcion ?? '') | transformText }}</p>
      </div>

      <div class="group">
        <p>Estado: <span class="bg-gradient-secondary">{{ (dato()?.estado ?? '') | transformText }}</span></p>
        <p>
          Prioridad:
          <span [class]="'bg-gradient-' + (
              dato()?.etiqueta?.categoria?.prioridad === 'baja' ? 'success' :
              dato()?.etiqueta?.categoria?.prioridad === 'media' ? 'warning' : 'error'
            )">
            {{ (dato()?.etiqueta?.categoria?.prioridad ?? '') | transformText }}
          </span>
        </p>
      </div>
    </div>

    <div class="info-general">
      <!-- üß† Categor√≠a y etiqueta -->
      <section class="categoria">
        <header class="bg-gradient-primary">
          <mat-icon>{{isAdmin ? 'info' : 'category' }}</mat-icon>
          <h3>{{isAdmin ? 'Informacion' : 'Categor√≠a' }}</h3>
        </header>

        <div class="info-group">
          @if (isAdmin) {
          <div style="padding-bottom: 10px; border-bottom: 1.5px solid rgb(199, 199, 199);" class="group">
            <div class="content-group">
              <span>Solicitante</span>
              <p><i class="fi fi-rr-circle-user"></i>{{ dato()?.usuario?.nombre }}</p>
            </div>
            <div class="content-group">
              <span>Correo</span>
              <p><i class="fi fi-rr-envelope"></i>{{ dato()?.usuario?.correo}}</p>
            </div>
          </div>
          }
          <div class="group">
            <div class="content-group">
              <span>Categor√≠a</span>
              <p><i class="fi fi-rr-resources"></i>{{ dato()?.etiqueta?.categoria?.nombre }}</p>
            </div>
            <div class="content-group">
              <span>Problema</span>
              <p><i class="fi fi-rr-exclamation"></i>{{ dato()?.etiqueta?.nombre }}</p>
            </div>
          </div>

          <div class="content-group">
            <span>Descripci√≥n de la categor√≠a</span>
            <p>{{ dato()?.etiqueta?.categoria?.descripcion }}</p>
          </div>

        </div>
      </section>

      <!-- ‚è±Ô∏è SLA -->
      <section class="info">
        <header class="bg-gradient-primary">
          <mat-icon>{{isAdmin ? 'calendar_today' : 'info' }}</mat-icon>
          <h3>{{ isAdmin ? 'Fechas y SLA' : 'Informaci√≥n' }}</h3>
        </header>

        <div class="info-group">
          <div class="group">
            <div class="content-group">
              <span>Fecha de creaci√≥n</span>
              <p><i class="fi fi-rr-calendar-plus"></i>{{ dato()?.fechaCreacion | date:'short' }}</p>
            </div>
            <div class="content-group">
              <span>Fecha de cierre</span>
              <p><i class="fi fi-rr-calendar-check"></i>{{ dato()?.fechaCierre | date:'short' }}</p>
            </div>
          </div>
          @if (isAdmin) {
          <div class="group">
            <div class="content-group">
              <span>Respuesta esperada</span>
              <p><i class="fi fi-rr-time-watch-calendar"></i>{{ dato()?.slaRespusta | date:'short' }}</p>
            </div>
            <div class="content-group">
              <span>Respuesta Obtenida</span>
              <p><i class="fi fi-rr-time-watch-calendar"></i>{{ fechaAsignacion | date:'short' }}</p>
            </div>
          </div>
          <div class="group">
            <div class="content-group">
              <span>Soluci√≥n esperada</span>
              <p><i class="fi fi-rr-time-watch-calendar"></i>{{ dato()?.slaSolucion | date:'short' }}</p>
            </div>
            <div class="content-group">
              <span>Soluci√≥n Obtenida</span>
              <p><i class="fi fi-rr-time-watch-calendar"></i>{{ fechaResuelto | date:'short' }}</p>
            </div>
          </div>
          <p [class]="cumplioSla('style')" style="margin: auto; text-align: center; font-size: .9em; width: fit-content; color: white; padding: 5px 15px; border-radius: 20px;">{{
                        cumplioSla('text')
                        }}</p>
          } @else {
          <div class="group">
            <div class="content-group">
              <span>Respuesta esperada</span>
              <p><i class="fi fi-rr-time-watch-calendar"></i>{{ dato()?.slaRespusta | date:'short' }}</p>
            </div>
            <div class="content-group">
              <span>Soluci√≥n esperada</span>
              <p><i class="fi fi-rr-time-watch-calendar"></i>{{ dato()?.slaSolucion | date:'short' }}</p>
            </div>
          </div>
          }
        </div>
      </section>
    </div>

    <!-- üë®‚Äçüîß T√©cnico asignado -->
    <section class="asignacion">
      <header class="bg-gradient-primary">
        <mat-icon>work</mat-icon>
        <h3>{{!isAdmin ? 'T√©cnico/a' : 'Asignaciones'}}</h3>
      </header>
      @if (isAdmin) {
      @for (asignacion of asignacionesOrdenadas; track $index) {
      <div class="info-group item">
        <div class="group-3">
          <img mat-card-image [src]="'http://localhost:3000/images/'+asignacion.tecnico.usuario.imagen"
            [alt]="asignacion.tecnico.usuario.nombre" />
          <span class="bg-gradient-primary">{{ asignacion.tecnico.motivoDisponible | transformText }}</span>
        </div>

        <div class="group">
          <div class="group-2">
            <div class="content-group">
              <span>Nombre</span>
              <p><i class="fi fi-rr-circle-user"></i>{{ asignacion.tecnico.usuario.nombre }}</p>
            </div>
            <div class="content-group">
              <span>Correo</span>
              <p><i class="fi fi-rr-envelope"></i>{{ asignacion.tecnico.usuario.correo }}</p>
            </div>
          </div>

          <div class="group-2">
            <div class="content-group">
              <span>M√©todo de asignaci√≥n</span>
              <p>
                <i [class]="asignacion.metodo === 'manual' ? 'fi fi-rr-hand-paper' : 'fi fi-rr-user-robot'"></i>
                {{ asignacion.metodo ?? ''| transformText }}
              </p>
            </div>
            <div class="content-group">
              <span>Motivo</span>
              <p><i class="fi fi-rr-comment-text"></i>{{ asignacion.motivo }}</p>
            </div>
          </div>
        </div>
        <div [hidden]="!asignacion.activo" class="active bg-gradient-success">
          <p>Activo</p>
        </div>
      </div>
      }
      } @else if (tecnicoAsignado) {
      <div class="info-group item">
        <div class="group-3">
          <img mat-card-image [src]="'http://localhost:3000/images/'+tecnicoAsignado.tecnico.usuario.imagen"
            [alt]="tecnicoAsignado.tecnico.usuario.nombre" />
          <span class="bg-gradient-primary">{{ tecnicoAsignado.tecnico.motivoDisponible | transformText }}</span>
        </div>

        <div class="group">
          <div class="group-2">
            <div class="content-group">
              <span>Nombre</span>
              <p><i class="fi fi-rr-circle-user"></i>{{ tecnicoAsignado.tecnico.usuario.nombre }}</p>
            </div>
            <div class="content-group">
              <span>Correo</span>
              <p><i class="fi fi-rr-envelope"></i>{{ tecnicoAsignado.tecnico.usuario.correo }}</p>
            </div>
          </div>

          <div class="group-2">
            <div class="content-group">
              <span>M√©todo de asignaci√≥n</span>
              <p>
                <i [class]="tecnicoAsignado.metodo === 'manual' ? 'fi fi-rr-hand-paper' : 'fi fi-rr-user-robot'"></i>
                {{ tecnicoAsignado.metodo ?? ''| transformText }}
              </p>
            </div>
            <div class="content-group">
              <span>Motivo</span>
              <p><i class="fi fi-rr-comment-text"></i>{{ tecnicoAsignado.motivo }}</p>
            </div>
          </div>
        </div>
        <div [hidden]="!tecnicoAsignado.activo" class="active bg-gradient-success">
          <p>Activo</p>
        </div>
      </div>
      } @else {
      <div class="info-group">
        <p style="text-align: center;">A√∫n no se ha asignado un t√©cnico a su ticket</p>
      </div>
      }
    </section>

    <!-- ‚≠ê Valoraci√≥n -->
    @if (dato()?.Valoracion?.length) {
    <section class="valoracion">
      <header class="bg-gradient-primary">
        <mat-icon>star</mat-icon>
        <h3>Valoraci√≥n</h3>
      </header>

      <div class="valoracion-card" *ngFor="let val of dato()?.Valoracion">
        <div class="encabezado">
          <div class="estrellas">
            <ng-container *ngFor="let star of [1,2,3,4,5]">
              <mat-icon [ngClass]="{ 'filled': star <= val.puntaje }">star_rate</mat-icon>
            </ng-container>
          </div>
          <span class="fecha">{{ val.fecha | date:'d \'de\' MMMM \'del\' y \'a las\' h:mm a' }}</span>
        </div>

        <p class="comentario">‚Äú{{ val.comentario }}‚Äù</p>
      </div>
    </section>
    }

    <!-- üìú Historial -->
    <section class="historial">
      <header class="bg-gradient-primary">
        <mat-icon>history</mat-icon>
        <h3>Historial</h3>
      </header>

      <div class="info-group">
        @for (h of dato()?.historial; track $index) {
        <div class="campo">
          <span>{{ h.fecha | date:'d \'de\' MMMM \'del\' y \'a las\' h:mm a' }}</span>
          <p>
            <strong>{{ (h.usuario?.nombre ) }}</strong> cambi√≥ de
            <em>{{ h.estadoAnterior | transformText }}</em> a <em>{{ h.estadoNuevo | transformText }}</em>
          </p>
          <div class="content-group">
            <span>Observaci√≥n</span>
            <p>{{ h.observacion }}</p>
          </div>
        </div>
        }
      </div>
    </section>

  </div>
  }
</main>